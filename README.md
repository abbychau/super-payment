# Super Payment Kun Backend

A Go-based REST API for a fictional corporate payment service that allows users to register invoice data for future payment processing with automatic bank transfers.

## Folder Structure

Clean architecture pattern.

```
super-payment/
├── cmd/server/           # Application entry point
├── internal/
│   ├── api/             # HTTP handlers and routing
│   ├── config/          # Configuration management
│   ├── middleware/      # HTTP middleware (auth, CORS, logging)
│   ├── models/          # Data models structs
│   ├── repository/      # Data access layer
│   └── service/         # Business logic layer
├── migrations/           # Database DDL and DML (test data included)
├── tests/                # Test files
├── go.mod                # Go module dependencies
└── README.md             # This file
```


## Prerequisites

- Go 1.21+
- MySQL 8.0+
- Git
- Docker with Docker Compose (optional)

## Setup Instructions

### 1. Clone the Repository

```bash
git clone https://github.com/abbymorgan/super-payment.git
cd super-payment
```

Then, you can start with Docker Compose (optional):

```bash
docker-compose up -d
# restart: docker-compose restart
```

Visit `http://localhost:8080/health` to check the health of the server.

or alternatively, you can set up manually as follows:

### 2. Install Go Dependencies

```bash
go mod tidy
```

### 3. Database Setup

Create a MySQL database:

```sql
CREATE DATABASE super_payment CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

Run the migration scripts:

```bash
mysql -u root -p super_payment < migrations/001_create_tables.sql
mysql -u root -p super_payment < migrations/002_insert_sample_data.sql
```

### 4. Environment Configuration

Copy the example environment file:

```bash
cp .env.example .env
```

Edit `.env` with your database credentials:

```env
# Server Configuration
SERVER_HOST=localhost
SERVER_PORT=8080

# Database Configuration
DB_HOST=localhost
DB_PORT=3306
DB_USER=your_db_user
DB_PASSWORD=your_db_password
DB_NAME=super_payment

# JWT Configuration
JWT_SECRET=your-super-secret-jwt-key-change-in-production
JWT_EXPIRY_HOURS=24
```

### 5. Run the Application

```bash
go run cmd/server/main.go
```

The server will start on `http://localhost:8080`

## API Spec and Usage Examples

1. Refer to the [OpenAPI Spec](./api-docs.yaml) for detailed API documentation.
2. Use `node test-api.js` to test the API endpoints (also read test-api.js for more details)
3. Some example curl requests are in [api.md](./api.md)

## Invoice Calculation Logic

The system automatically calculates invoice amounts based on the following fee and tax structure:

```
Payment Amount: 100,000 (input)
Fee (4%): 100,000 × 0.04 = 4,000
Consumption Tax (10% on fee): 4,000 × 0.10 = 400
Invoice Amount: 100,000 + 4,000 + 400 = 104,400
```

## Data Models

Live Version: [models.go](internal/models/models.go)

## Tests

Before running tests, make sure to start the test database or docker-compose:

```bash
go test ./tests/... -v
```

For test coverage:

```bash
go test ./tests/... -cover
```

## Production Deployment Information

Use Docker image registry: `https://hub.docker.com/r/abbychau/super-payment`

The above is built from `main` branch using GitHub Actions. Environment variables should be referred to the `.env.example` file.

## Code Scaning and Security

[Report](https://github.com/abbychau/super-payment/security/code-scanning)

Generated by gosec and uploaded SARIF file to GitHub.

Note: G115 issues are false positives as we cast only positive integers for primary keys. Consider disabling this rule, [more info](https://dev.to/ccoveille/about-the-gosec-g115-drama-or-how-i-faced-back-integer-conversion-overflow-in-go-1302).